name: Build Fedora CoreOS PXE Images

on:
  workflow_dispatch:
    inputs:
      stream:
        description: 'CoreOS stream to build'
        required: true
        default: 'testing-devel'
        type: choice
        options:
          - stable
          - testing
          - next
          - testing-devel
          - rawhide
      arch:
        description: 'Target architecture'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - aarch64
      force:
        description: 'Force rebuild even if no changes'
        required: false
        default: false
        type: boolean
      skip_tests:
        description: 'Skip Kola tests to save time'
        required: false
        default: false
        type: boolean
      sector_size:
        description: 'Metal disk image sector size to build'
        required: false
        default: '512'
        type: choice
        options:
          - '512'
          - '4096'
          - 'both'

jobs:
  build-pxe:
    runs-on: ubuntu-latest

    steps:
      - name: Maximize disk space
        run: |
          echo "Disk space before cleanup:"
          df -h

          # Remove unnecessary packages and files
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

          echo "Disk space after cleanup:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up build environment
        run: |
          # Install podman if not available
          if ! command -v podman &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y podman
          fi

          # Create workspace directory
          mkdir -p "${GITHUB_WORKSPACE}/builds"

          echo "Environment setup complete"
          podman --version

      - name: Pull coreos-assembler image
        run: |
          echo "Pulling coreos-assembler container image..."
          podman pull quay.io/coreos-assembler/coreos-assembler:latest

      - name: Initialize CoreOS build
        run: |
          # Determine branch based on stream
          case "${{ inputs.stream }}" in
            stable|testing|next|testing-devel)
              BRANCH="${{ inputs.stream }}"
              ;;
            rawhide)
              BRANCH="rawhide"
              ;;
            *)
              BRANCH="testing-devel"
              ;;
          esac

          echo "Initializing build for stream: ${{ inputs.stream }}, branch: ${BRANCH}"

          sudo podman run --rm \
            -v "${GITHUB_WORKSPACE}/builds:/srv" \
            --workdir /srv \
            --security-opt label=disable \
            quay.io/coreos-assembler/coreos-assembler:latest \
            init --force \
              --branch "${BRANCH}" \
              https://github.com/coreos/fedora-coreos-config

          echo "Build initialized successfully"

      - name: Fetch packages
        run: |
          STRICT_FLAG=""
          if [[ "${{ inputs.stream }}" != "rawhide" ]]; then
            STRICT_FLAG="--strict"
          fi

          echo "Fetching packages for ${{ inputs.stream }}..."

          sudo podman run --rm \
            -v "${GITHUB_WORKSPACE}/builds:/srv" \
            --workdir /srv \
            --security-opt label=disable \
            quay.io/coreos-assembler/coreos-assembler:latest \
            fetch ${STRICT_FLAG}

          echo "Package fetch complete"

      - name: Build OSTree
        run: |
          STRICT_FLAG=""
          FORCE_FLAG=""

          if [[ "${{ inputs.stream }}" != "rawhide" ]]; then
            STRICT_FLAG="--strict"
          fi

          if [[ "${{ inputs.force }}" == "true" ]]; then
            FORCE_FLAG="--force"
          fi

          echo "Building OSTree..."

          sudo podman run --rm \
            -v "${GITHUB_WORKSPACE}/builds:/srv" \
            --workdir /srv \
            --security-opt label=disable \
            quay.io/coreos-assembler/coreos-assembler:latest \
            build ostree ${STRICT_FLAG} --skip-prune ${FORCE_FLAG}

          echo "OSTree build complete"

      - name: Build QEMU image
        run: |
          echo "Building QEMU image..."

          sudo podman run --rm \
            -v "${GITHUB_WORKSPACE}/builds:/srv" \
            --workdir /srv \
            --security-opt label=disable \
            quay.io/coreos-assembler/coreos-assembler:latest \
            buildextend-qemu

          echo "QEMU image build complete"

      - name: Run Kola tests
        if: ${{ !inputs.skip_tests }}
        run: |
          echo "Running Kola tests..."

          # Check if KVM is available
          if [ -e /dev/kvm ]; then
            KVM_FLAG="--device /dev/kvm"
            echo "KVM device available, enabling hardware acceleration"
          else
            KVM_FLAG=""
            echo "KVM device not available, tests will run slower or be skipped"
          fi

          # Run basic Kola tests with limited parallelism
          sudo podman run --rm \
            -v "${GITHUB_WORKSPACE}/builds:/srv" \
            --workdir /srv \
            --security-opt label=disable \
            ${KVM_FLAG} \
            quay.io/coreos-assembler/coreos-assembler:latest \
            kola run --parallel 2 --basic-qemu-scenarios || {
              echo "Warning: Kola tests failed, but continuing..."
            }

          echo "Kola tests complete"

      - name: Build metal artifacts
        run: |
          echo "Building metal artifacts (sector size: ${{ inputs.sector_size }})..."

          # Build metal (standard 512-byte sector)
          if [[ "${{ inputs.sector_size }}" == "512" || "${{ inputs.sector_size }}" == "both" ]]; then
            echo "Building metal (512-byte sectors)..."
            sudo podman run --rm \
              -v "${GITHUB_WORKSPACE}/builds:/srv" \
              --workdir /srv \
              --security-opt label=disable \
              quay.io/coreos-assembler/coreos-assembler:latest \
              buildextend-metal

            echo "âœ“ metal artifact build complete"
          else
            echo "Skipping metal (512-byte) build"
          fi

          # Build metal4k (4K sector optimized)
          if [[ "${{ inputs.sector_size }}" == "4096" || "${{ inputs.sector_size }}" == "both" ]]; then
            echo "Building metal4k (4K sectors)..."
            sudo podman run --rm \
              -v "${GITHUB_WORKSPACE}/builds:/srv" \
              --workdir /srv \
              --security-opt label=disable \
              quay.io/coreos-assembler/coreos-assembler:latest \
              buildextend-metal4k

            echo "âœ“ metal4k artifact build complete"
          else
            echo "Skipping metal4k (4K) build"
          fi

      - name: Build live ISO (PXE artifacts)
        run: |
          echo "Building live ISO with PXE artifacts..."

          sudo podman run --rm \
            -v "${GITHUB_WORKSPACE}/builds:/srv" \
            --workdir /srv \
            --security-opt label=disable \
            quay.io/coreos-assembler/coreos-assembler:latest \
            buildextend-live

          echo "Live ISO build complete"

      - name: Extract build information
        id: build-info
        run: |
          # Get the build ID
          BUILD_ID=$(readlink "${GITHUB_WORKSPACE}/builds/builds/latest")
          echo "build_id=${BUILD_ID}" >> $GITHUB_OUTPUT
          echo "Build ID: ${BUILD_ID}"

          # Get architecture
          ARCH="${{ inputs.arch }}"
          echo "arch=${ARCH}" >> $GITHUB_OUTPUT

          # List built artifacts
          echo "Built artifacts:"
          ls -lh "${GITHUB_WORKSPACE}/builds/builds/${BUILD_ID}/${ARCH}/" || true

      - name: Compress artifacts
        run: |
          echo "Compressing artifacts..."

          sudo podman run --rm \
            -v "${GITHUB_WORKSPACE}/builds:/srv" \
            --workdir /srv \
            --security-opt label=disable \
            quay.io/coreos-assembler/coreos-assembler:latest \
            compress

          echo "Compression complete"

      - name: Extract and prepare PXE artifacts for upload
        run: |
          BUILD_ID="${{ steps.build-info.outputs.build_id }}"
          ARCH="${{ steps.build-info.outputs.arch }}"
          BUILD_DIR="${GITHUB_WORKSPACE}/builds/builds/${BUILD_ID}/${ARCH}"
          UPLOAD_DIR="${GITHUB_WORKSPACE}/pxe-artifacts"

          mkdir -p "${UPLOAD_DIR}"

          # Extract separate PXE files using cosa meta
          # These are the actual files that should be published for PXE booting
          cd "${GITHUB_WORKSPACE}/builds"

          # Get paths to the separate kernel, initramfs, and rootfs files
          KERNEL_PATH=$(sudo podman run --rm \
            -v "${GITHUB_WORKSPACE}/builds:/srv" \
            --workdir /srv \
            --security-opt label=disable \
            quay.io/coreos-assembler/coreos-assembler:latest \
            cosa meta --image-path live-kernel 2>/dev/null || echo "")

          INITRAMFS_PATH=$(sudo podman run --rm \
            -v "${GITHUB_WORKSPACE}/builds:/srv" \
            --workdir /srv \
            --security-opt label=disable \
            quay.io/coreos-assembler/coreos-assembler:latest \
            cosa meta --image-path live-initramfs 2>/dev/null || echo "")

          ROOTFS_PATH=$(sudo podman run --rm \
            -v "${GITHUB_WORKSPACE}/builds:/srv" \
            --workdir /srv \
            --security-opt label=disable \
            quay.io/coreos-assembler/coreos-assembler:latest \
            cosa meta --image-path live-rootfs 2>/dev/null || echo "")

          cd "${GITHUB_WORKSPACE}"

          echo "Kernel path: ${KERNEL_PATH}"
          echo "Initramfs path: ${INITRAMFS_PATH}"
          echo "Rootfs path: ${ROOTFS_PATH}"

          # Copy the separate PXE files with standard naming
          if [ -n "${KERNEL_PATH}" ] && [ -f "${GITHUB_WORKSPACE}/builds/${KERNEL_PATH}" ]; then
            cp "${GITHUB_WORKSPACE}/builds/${KERNEL_PATH}" "${UPLOAD_DIR}/fedora-coreos-${BUILD_ID}-live-kernel-${ARCH}"
            echo "âœ“ Copied kernel"
          fi

          if [ -n "${INITRAMFS_PATH}" ] && [ -f "${GITHUB_WORKSPACE}/builds/${INITRAMFS_PATH}" ]; then
            cp "${GITHUB_WORKSPACE}/builds/${INITRAMFS_PATH}" "${UPLOAD_DIR}/fedora-coreos-${BUILD_ID}-live-initramfs.${ARCH}.img"
            echo "âœ“ Copied initramfs"
          fi

          if [ -n "${ROOTFS_PATH}" ] && [ -f "${GITHUB_WORKSPACE}/builds/${ROOTFS_PATH}" ]; then
            cp "${GITHUB_WORKSPACE}/builds/${ROOTFS_PATH}" "${UPLOAD_DIR}/fedora-coreos-${BUILD_ID}-live-rootfs.${ARCH}.img"
            echo "âœ“ Copied rootfs"
          fi

          # Also copy the live ISO for reference
          if [ -f "${BUILD_DIR}/fedora-coreos-${BUILD_ID}-live.${ARCH}.iso" ]; then
            cp "${BUILD_DIR}/fedora-coreos-${BUILD_ID}-live.${ARCH}.iso" "${UPLOAD_DIR}/"
            echo "âœ“ Copied live ISO"
          fi

          # Copy metal images (used for bare metal PXE installation)
          if [ -f "${BUILD_DIR}/fedora-coreos-${BUILD_ID}-metal.${ARCH}.raw.xz" ]; then
            cp "${BUILD_DIR}/fedora-coreos-${BUILD_ID}-metal.${ARCH}.raw.xz" "${UPLOAD_DIR}/"
            echo "âœ“ Copied metal image"
          fi

          if [ -f "${BUILD_DIR}/fedora-coreos-${BUILD_ID}-metal4k.${ARCH}.raw.xz" ]; then
            cp "${BUILD_DIR}/fedora-coreos-${BUILD_ID}-metal4k.${ARCH}.raw.xz" "${UPLOAD_DIR}/"
            echo "âœ“ Copied metal4k image"
          fi

          # Copy metadata
          if [ -f "${BUILD_DIR}/meta.json" ]; then
            cp "${BUILD_DIR}/meta.json" "${UPLOAD_DIR}/"
            echo "âœ“ Copied meta.json"
          fi

          if [ -f "${BUILD_DIR}/commitmeta.json" ]; then
            cp "${BUILD_DIR}/commitmeta.json" "${UPLOAD_DIR}/"
            echo "âœ“ Copied commitmeta.json"
          fi

          # Create a README with usage instructions
          {
            echo "# Fedora CoreOS PXE Artifacts"
            echo ""
            echo "This directory contains the complete set of artifacts needed for PXE booting Fedora CoreOS."
            echo ""
            echo "## Files Included"
            echo ""
            echo "### PXE Boot Files (Ready to Use)"
            echo "- \`fedora-coreos-${BUILD_ID}-live-kernel-${ARCH}\` - Linux kernel"
            echo "- \`fedora-coreos-${BUILD_ID}-live-initramfs.${ARCH}.img\` - Initial RAM filesystem"
            echo "- \`fedora-coreos-${BUILD_ID}-live-rootfs.${ARCH}.img\` - Root filesystem image"
            echo ""
            echo "### Additional Artifacts"
            echo "- \`fedora-coreos-${BUILD_ID}-live.${ARCH}.iso\` - Bootable ISO (contains the above PXE files)"
            echo "- \`fedora-coreos-${BUILD_ID}-metal.${ARCH}.raw.xz\` - Bare metal disk image (512-byte sectors)"
            echo "- \`fedora-coreos-${BUILD_ID}-metal4k.${ARCH}.raw.xz\` - Bare metal disk image (4K sectors)"
            echo "- \`meta.json\` - Build metadata"
            echo "- \`commitmeta.json\` - Commit metadata"
            echo ""
            echo "## Using for PXE Boot"
            echo ""
            echo "### Option 1: Direct PXE Boot (Recommended)"
            echo ""
            echo "The kernel, initramfs, and rootfs files are **already extracted and ready to use**."
            echo "No ISO mounting required!"
            echo ""
            echo "1. Upload files to your TFTP/HTTP server:"
            echo "   - \`fedora-coreos-${BUILD_ID}-live-kernel-${ARCH}\` â†’ TFTP server"
            echo "   - \`fedora-coreos-${BUILD_ID}-live-initramfs.${ARCH}.img\` â†’ TFTP server"
            echo "   - \`fedora-coreos-${BUILD_ID}-live-rootfs.${ARCH}.img\` â†’ HTTP server"
            echo ""
            echo "2. Example iPXE configuration:"
            echo ""
            echo '```'
            echo "#!ipxe"
            echo "set BASEURL http://your-server/path"
            echo "kernel \${BASEURL}/fedora-coreos-${BUILD_ID}-live-kernel-${ARCH} initrd=main coreos.live.rootfs_url=\${BASEURL}/fedora-coreos-${BUILD_ID}-live-rootfs.${ARCH}.img"
            echo "initrd --name main \${BASEURL}/fedora-coreos-${BUILD_ID}-live-initramfs.${ARCH}.img"
            echo "boot"
            echo '```'
            echo ""
            echo "3. Example PXE/PXELINUX configuration:"
            echo ""
            echo '```'
            echo "LABEL CoreOS"
            echo "  MENU LABEL Fedora CoreOS ${BUILD_ID}"
            echo "  KERNEL fedora-coreos-${BUILD_ID}-live-kernel-${ARCH}"
            echo "  APPEND initrd=fedora-coreos-${BUILD_ID}-live-initramfs.${ARCH}.img coreos.live.rootfs_url=http://your-server/fedora-coreos-${BUILD_ID}-live-rootfs.${ARCH}.img"
            echo '```'
            echo ""
            echo "### Option 2: Using coreos-installer"
            echo ""
            echo "You can also use the live ISO with coreos-installer to perform installations."
            echo ""
            echo "## Build Information"
            echo ""
            echo "- **Build ID**: ${BUILD_ID}"
            echo "- **Stream**: ${{ inputs.stream }}"
            echo "- **Architecture**: ${ARCH}"
            echo "- **Built**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            echo ""
            echo "## More Information"
            echo ""
            echo "- [Fedora CoreOS Documentation](https://docs.fedoraproject.org/en-US/fedora-coreos/)"
            echo "- [PXE Boot Reference](https://docs.fedoraproject.org/en-US/fedora-coreos/live-reference/)"
            echo "- [Bare Metal Installation](https://docs.fedoraproject.org/en-US/fedora-coreos/bare-metal/)"
          } > "${UPLOAD_DIR}/README.md"

          echo "PXE artifacts prepared in ${UPLOAD_DIR}"
          ls -lh "${UPLOAD_DIR}"

      - name: Upload PXE artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fedora-coreos-pxe-${{ inputs.stream }}-${{ steps.build-info.outputs.build_id }}-${{ inputs.arch }}
          path: pxe-artifacts/
          retention-days: 30
          compression-level: 0  # Already compressed

      - name: Upload full build directory
        uses: actions/upload-artifact@v4
        with:
          name: fedora-coreos-full-build-${{ inputs.stream }}-${{ steps.build-info.outputs.build_id }}-${{ inputs.arch }}
          path: builds/builds/latest/
          retention-days: 7
          compression-level: 6

      - name: Build summary
        run: |
          BUILD_ID="${{ steps.build-info.outputs.build_id }}"
          ARCH="${{ steps.build-info.outputs.arch }}"

          echo "## Fedora CoreOS Build Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Stream:** ${{ inputs.stream }}" >> $GITHUB_STEP_SUMMARY
          echo "**Build ID:** ${BUILD_ID}" >> $GITHUB_STEP_SUMMARY
          echo "**Architecture:** ${ARCH}" >> $GITHUB_STEP_SUMMARY
          echo "**Sector Size:** ${{ inputs.sector_size }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### PXE Files (Ready to Deploy):" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Kernel** (\`fedora-coreos-${BUILD_ID}-live-kernel-${ARCH}\`)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Initramfs** (\`fedora-coreos-${BUILD_ID}-live-initramfs.${ARCH}.img\`)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Rootfs** (\`fedora-coreos-${BUILD_ID}-live-rootfs.${ARCH}.img\`)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Additional Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Live ISO" >> $GITHUB_STEP_SUMMARY

          # Conditionally show which metal artifacts were built
          if [[ "${{ inputs.sector_size }}" == "512" || "${{ inputs.sector_size }}" == "both" ]]; then
            echo "- âœ… Metal disk image (512-byte sectors)" >> $GITHUB_STEP_SUMMARY
          fi
          if [[ "${{ inputs.sector_size }}" == "4096" || "${{ inputs.sector_size }}" == "both" ]]; then
            echo "- âœ… Metal4k disk image (4K sectors)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`fedora-coreos-pxe-*\` artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. The PXE files are **already extracted** and ready to use - no ISO mounting needed!" >> $GITHUB_STEP_SUMMARY
          echo "3. Upload to your TFTP/HTTP server (see README.md in artifacts for configuration examples)" >> $GITHUB_STEP_SUMMARY

          echo "Disk space after build:"
          df -h
